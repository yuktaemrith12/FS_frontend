<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CST3144 Lessons (Vue 2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Vue 2 -->
  <script src="https://unpkg.com/vue@2.7.14/dist/vue.min.js"></script>

  <!-- Font Awesome (icons) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Your stylesheet -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="app" class="container">
    <!-- Header / Toolbar -->
    <header class="toolbar">
      <div class="brand">
        <i class="fa-solid fa-graduation-cap"></i> CST3144 Lessons
      </div>

      <div class="controls">
        <label class="control">
          <span>Sort by</span>
          <select v-model="sortBy" aria-label="Sort attribute">
            <option value="topic">Subject</option>
            <option value="location">Location</option>
            <option value="price">Price</option>
            <option value="space">Spaces</option>
          </select>
        </label>

        <label class="control">
          <span>Order</span>
          <select v-model="sortDir" aria-label="Sort order">
            <option value="asc">Ascending</option>
            <option value="desc">Descending</option>
          </select>
        </label>

        <!-- (Optional) base-marks search: client-side filter -->
        <label class="control search">
          <span class="sr-only">Search</span>
          <input v-model.trim="searchTerm"
                 placeholder="Search subject, location, price, spaces…" />
        </label>

        <button class="btn primary"
                :disabled="cart.length===0"
                @click="showCart = !showCart">
          <i class="fa-solid fa-cart-shopping"></i>
          Cart ({{ cart.length }})
        </button>
      </div>
    </header>

    <!-- LESSONS VIEW -->
    <main v-if="!showCart">
      <p v-if="loading" class="muted">Loading lessons…</p>
      <p v-else-if="sortedLessons.length === 0" class="muted">No results.</p>

      <section class="grid">
        <article class="card" v-for="l in sortedLessons" :key="l._id">
          <h3 class="title">
            <i class="fa-solid fa-book"></i> {{ l.topic }}
          </h3>
          <ul class="meta">
            <li><strong>Location:</strong> {{ l.location }}</li>
            <li><strong>Price:</strong> Rs {{ l.price }}</li>
            <li><strong>Spaces:</strong> {{ l.space }}</li>
          </ul>
          <button class="btn"
                  :class="{ primary: l.space>0 }"
                  :disabled="l.space <= 0"
                  @click="addToCart(l)">
            Add to Cart
          </button>
        </article>
      </section>
    </main>

    <!-- CART / CHECKOUT VIEW -->
    <main v-else>
      <h2>Cart</h2>
      <p v-if="cart.length===0" class="muted">Your cart is empty.</p>

      <section class="grid cart">
        <article class="card" v-for="(l, idx) in cart" :key="idx">
          <h3 class="title">
            <i class="fa-solid fa-book-open"></i> {{ l.topic }}
          </h3>
          <ul class="meta">
            <li><strong>Location:</strong> {{ l.location }}</li>
            <li><strong>Price:</strong> Rs {{ l.price }}</li>
          </ul>
          <button class="btn danger" @click="removeFromCart(idx)">
            Remove
          </button>
        </article>
      </section>

      <hr/>

      <section class="checkout">
        <h3>Checkout</h3>
        <div class="form">
          <label>
            Name
            <input v-model="order.name" placeholder="Letters only" />
            <small :class="validName ? 'ok' : 'err'">
              {{ validName ? '✔ Looks good' : 'Letters only (A–Z, spaces)' }}
            </small>
          </label>

          <label>
            Phone
            <input v-model="order.phone" placeholder="Numbers only" />
            <small :class="validPhone ? 'ok' : 'err'">
              {{ validPhone ? '✔ Looks good' : 'Digits only (0–9)' }}
            </small>
          </label>

          <button class="btn primary"
                  :disabled="!canCheckout"
                  @click="submitOrder">
            Checkout
          </button>
        </div>

        <p v-if="message" class="message">{{ message }}</p>
      </section>
    </main>
  </div>

  <script>

    // Root Vue 2 instance
    new Vue({
      el: "#app",

      data: {
        //  Render URL 
        API_BASE: "https://YOUR-RENDER-APP.onrender.com",

        lessons: [],
        loading: true,

        // UI state
        showCart: false,
        cart: [],

        // sorting + search
        sortBy: "topic",
        sortDir: "asc",
        searchTerm: "",

        // checkout
        order: { name: "", phone: "" },
        message: ""
      },

      // computed properties for validation, filtering, sorting
      computed: {
        validName: function () {
          return /^[A-Za-z ]+$/.test(this.order.name || "");
        },
        validPhone: function () {
          return /^[0-9]+$/.test(this.order.phone || "");
        },
        canCheckout: function () {
          return this.cart.length > 0 && this.validName && this.validPhone;
        },

        // base marks: client-side filter
        filteredLessons: function () {
          var q = (this.searchTerm || "").toLowerCase();
          if (!q) return this.lessons;
          return this.lessons.filter(function (l) {
            return (
              String(l.topic).toLowerCase().includes(q) ||
              String(l.location).toLowerCase().includes(q) ||
              String(l.price).toLowerCase().includes(q) ||
              String(l.space).toLowerCase().includes(q)
            );
          });
        },

        // sort after filter
        sortedLessons: function () {
          var arr = this.filteredLessons.slice();
          var key = this.sortBy;
          var dir = this.sortDir === "asc" ? 1 : -1;

          return arr.sort(function (a, b) {
            var va = a[key], vb = b[key];
            if (typeof va === "string") va = va.toLowerCase();
            if (typeof vb === "string") vb = vb.toLowerCase();
            if (va < vb) return -1 * dir;
            if (va > vb) return  1 * dir;
            return 0;
          });
        }
      },

      // Lesson Management & Order Handling (Methods Section)
      methods: {
        loadLessons: function () {
          var self = this;
          fetch(self.API_BASE + "/lessons")
            .then(function (res) {
              if (!res.ok) throw new Error("Failed to fetch lessons");
              return res.json();
            })
            .then(function (json) {
              self.lessons = json;
            })
            .catch(function () {
              // Week 0 fallback seed data if backend not yet live
              self.lessons = [
                { _id:"1", topic:"math",     location:"Hendon",        price:100, space:5 },
                { _id:"2", topic:"science",  location:"Colindale",     price:90,  space:5 },
                { _id:"3", topic:"english",  location:"Brent Cross",   price:80,  space:5 },
                { _id:"4", topic:"music",    location:"Golders Green", price:120, space:5 },
                { _id:"5", topic:"art",      location:"Hendon",        price:75,  space:5 },
                { _id:"6", topic:"coding",   location:"Wood Green",    price:110, space:5 },
                { _id:"7", topic:"dance",    location:"Hendon",        price:95,  space:5 },
                { _id:"8", topic:"drama",    location:"Colindale",     price:85,  space:5 },
                { _id:"9", topic:"biology",  location:"Brent Cross",   price:105, space:5 },
                { _id:"10",topic:"chemistry",location:"Golders Green", price:115, space:5 }
              ];
            })
            .finally(function () {
              self.loading = false;
            });
        },

        addToCart: function (lesson) {
          if (lesson.space > 0) {
            this.cart.push(lesson);
            lesson.space -= 1;
          }
        },

        removeFromCart: function (idx) {
          var lesson = this.cart.splice(idx, 1)[0];
          var original = this.lessons.find(function (l) { return l._id === lesson._id; });
          if (original) original.space += 1;
        },

        submitOrder: function () {
          var self = this;

          var payload = {
            name: self.order.name.trim(),
            phone: self.order.phone.trim(),
            lessonIDs: self.cart.map(function (l) { return l._id; }),
            space: self.cart.length
          };

          // Attempt real POST if backend is available; otherwise show success.
          fetch(self.API_BASE + "/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          })
          .then(function (res) {
            if (!res.ok) throw new Error("Order API failed");
            self.message = "✅ Order submitted!";
          })
          .catch(function () {
            self.message = "✅ Order submitted! (offline demo)";
          })
          .finally(function () {
            self.cart = [];
            self.order = { name: "", phone: "" };
            self.showCart = false;
          });
        }
      },

      mounted: function () {
        this.loadLessons();
      }
    });
  </script>
</body>
</html>
